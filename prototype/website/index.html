<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Mutable Bunnies</title>
    <link rel="icon" href="src/images/favicon.ico" type="image/x-icon"/>
    <link rel="manifest" href="manifest.json">
    <!--<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0"/>-->
    <meta name="viewport" content="initial-scale=1, maximum-scale=1,target-densitydpi=device-dpi, user-scalable=no">
    <script src="src/script/eventbus.js"></script>
    <script src="src/script/network.js"></script>
    <script src="src/script/connection.js"></script>
    <script src="src/script/application.js"></script>
    <script src="src/script/service/patcher.js"></script>
    <script src="src/script/service/realmregistry.js"></script>
    <script src="src/script/service/realmserver.js"></script>
    <script src="src/script/service/authentication.js"></script>
    <script src="bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <link rel="import" href="src/game-app/app-view.html">
    <link rel="stylesheet" href="src/style/style.css">
    <title></title>
    <style>
        @keyframes fadein {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
    </style>
    <script>
        Polymer.passiveTouchGestures = true;

        function send_message_to_sw(msg) {
            return new Promise((resolve, reject) => {
                let channel = new MessageChannel();

                channel.port1.onmessage = (event) => {
                    if (event.data.error) {
                        reject(event.data.error);
                    } else {
                        resolve(event.data);
                    }
                };
                if (navigator.serviceWorker.controller) {
                    navigator.serviceWorker.controller.postMessage(msg, [channel.port2]);
                } else {
                    // failed to retrieve controller, assume online.
                    resolve({
                        data: {
                            offline: false
                        }
                    });
                }
            });
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service_worker.js')
                    .then((registration) => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    }, (err) => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });

            navigator.serviceWorker.ready.then(() => {
                send_message_to_sw("is offline?").then(data => {
                    application.offline = data.offline;
                    console.log(`offline=${application.offline}`);
                    application.publish('offline', data.offline);

                    if (application.offline) {
                        application.view("offline-view");
                    }
                });
            });
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            window.pwa = e;
            application.publish('installed', !window.pwa);
        });

        window.isPWA = (window.matchMedia('(display-mode: fullscreen)').matches)
            || (window.matchMedia('(display-mode: standalone)').matches);

        application.onAuthentication(() => {
            if (window.isPWA) {
                document.documentElement.requestFullscreen()
                    .catch((e) => {
                        console.log(e);
                    });
            }
        });
    </script>
</head>
<body oncontextmenu="return application.development.rightClick;">

<app-view></app-view>

</body>
</html>
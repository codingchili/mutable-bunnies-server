<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/iron-icons/iron-icons.html">

<!--
    @author Robin Duda
    Realm chat.
 -->

<dom-module id="chat-box">
    <link rel="import" href="../../style/theme.css" type="css">
    <link rel="import" href="../../style/style.css" type="css">
    <template>
        <style>
            :host {
                display: block;
                position: absolute;
                bottom: 16px;
                left: 16px;
            }

            .chat-box {
                width: 416px;
                height: 246px;
            }

            .input {
                position: absolute;
                display: block;
                bottom: 2px;
                left: 0px;
                right: 16px;
            }

            --paper-input-container-input {
                font-size: 9px;
            }

            .messages {
                list-style-type: none;
                font-size: smaller;
                margin-left: 8px;
                margin-top: 2px;
                padding-left: 0px;
                margin-bottom: 0px;
            }

            .system {
                color: #ffc200;
            }

            .party {
                color: #2bc7ff;
            }

            @media (max-width: 1268px) {
                :host {
                    bottom: 64px;
                    height: 47px;
                    display: block;
                    left: 50%;
                    transform: translateX(-50%);
                }

                .chat-box {
                    bottom: 216px;
                }
            }

            .hide-chat {
                position: absolute;
                right: 8px;
                top: 8px;
            }

            .chat-icon {
                margin-right: 6px;
                width: 32px;
                height: 32px;
                margin-left: 6px;
                margin-top: 4px;
            }

            .list {
                margin-top: 8px;
            }

        </style>

        <template is="dom-if" if="[[!minimized]]">
            <paper-material elevation="3" class="interface-box chat-box">
                <iron-icon on-down="_minimize" class="hide-chat" icon="icons:close"></iron-icon>

                <div class="list">
                    <ul class="messages">
                        <template is="dom-repeat" items="{{messages}}" as="message">
                            <li class$="text [[_system(message)]] [[_party(message)]]">
                                [[_name(message)]][[message.text]]
                            </li>
                        </template>
                    </ul>
                </div>
                <paper-input value="{{message}}" id="message" class="input" on-input="_input" maxlength="60"
                             placeholder="[[channel]]"
                             on-keydown="submit"></paper-input>

            </paper-material>
        </template>

        <template is="dom-if" if="[[minimized]]">
            <paper-material elevation="3" class="interface-box chat-button">
                <iron-icon class="chat-icon" on-down="_maximize" icon="icons:speaker-notes"></iron-icon>
            </paper-material>
        </template>

    </template>
    <script>
        class ChatBox extends Polymer.GestureEventListeners(Polymer.Element) {

            static get is() {
                return 'chat-box';
            }

            ready() {
                super.ready();

                this.MAX_MESSAGES = 14;
                this.listeners = false;
                this.minimized = true;

                this.set("messages", [{
                    system: true,
                    text: `Server version ${patch.version} ${patch.name}.`
                }]);

                this.set("message", "");
                application.onGameLoaded(() => {
                    this.channel = 'say';
                    this._setHandler();
                });
            }

            _minimize() {
                this.minimized = true;
            }

            _maximize() {
                this.minimized = false;
                setTimeout(() => {
                    this._focus();
                }, 1);
            }

            _input() {
                if (this.message === '/s') {
                    this.channel = 'say';
                    this.message = "";
                }
                if (this.message === '/p') {
                    this.channel = 'party';
                    this.message = "";
                }
            }

            _setHandler() {
                game.chat.onChatMessage(msg => {
                    this.add(msg);
                });

                input.onKeysListener({
                    down: () => {
                        this._focus();
                    }
                }, ['Enter']);

            }

            _focus() {
                let message = this.shadowRoot.querySelector('#message');
                if (this.shadowRoot.activeElement !== message) {
                    message.focus();
                }
            }

            _system(message) {
                return (message.system) ? 'system' : '';
            }

            _party(message) {
                return (message.party) ? 'party' : '';
            }

            send() {
                if (this.message.length !== 0) {
                    if (this.channel === 'party') {
                        social.party_message(() => {
                            //
                        }, this.message.replace('/p', ''));
                    } else {
                        game.chat.send(this.message);
                    }
                    this.set("message", "");
                    this.shadowRoot.querySelector('#message').blur();
                }
            }

            add(message) {
                if (message.text) {
                    this.push("messages", message);
                }
                while (this.messages.length >= this.MAX_MESSAGES) {
                    this.splice("messages", 0, 1);
                }
            }

            _name(message) {
                if (message.source && !message.system) {
                    if (message.party) {
                        return `${message.source}: `;
                    } else {
                        if (message.name) {
                            return message.name;
                        } else {
                            message.name = game.lookup(message.source).name;
                            return `${message.name}: `;
                        }
                    }
                } else {
                    return '';
                }
            }

            submit(event) {
                if (!this.listeners) {
                    this.shadowRoot.querySelector('#message').addEventListener('blur', () => {
                        input.unblock();
                    }, true);

                    this.shadowRoot.querySelector('#message').addEventListener('focus', () => {
                        input.block();
                    }, true);

                    input.block();
                }

                if (event.key === 'Enter')
                    this.send();
                if (event.key === 'Escape') {
                    this.shadowRoot.querySelector('#message').blur();
                }
            }
        }

        window.customElements.define(ChatBox.is, ChatBox);
    </script>
</dom-module>
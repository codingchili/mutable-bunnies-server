<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-ripple/paper-ripple.html">
<link rel="import" href="../../bower_components/paper-spinner/paper-spinner-lite.html">
<link rel="import" href="../../bower_components/paper-tooltip/paper-tooltip.html">
<link rel="import" href="../../bower_components/paper-progress/paper-progress.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="mega-loader.html">


<!--
    @author Robin Duda
    Polymer element for the patch download.
 -->

<dom-module id="patch-download">
    <link rel="import" href="../style/theme.css" type="css">
    <link rel="import" href="../style/style.css" type="css">
    <template>
        <style>
            :host {
                display: block;
            }

            .container {
                height: 318px;
                width: 80%;
                max-width: 825px;
                display: block;
                margin-top: 128px;
            }

            .loading-text {
                text-align: center;
                font-size: smaller;
                width: 100%;
                margin-top: 32px;
            }

            .download-progress {
                margin-top: 128px;
                margin-left: auto;
                margin-right: auto;
                width: 95%;
                top: 130px;
            }

            paper-progress {
                --paper-progress-transition-duration: 0.16s;
                --paper-progress-transition-timing-function: default;
                --paper-progress-transition-transition-delay: 0s;
            }

            .patch-name {
                position: absolute;
                top: 20px;
                display: block;
                right: 0;
                left: 0;
                text-align: center;
                font-size: 22px
            }

            .patch-version {
                display: block;
                position: absolute;
                top: 48px;
                left: 0;
                right: 0;
                font-size: small;
                text-align: center;
            }

            .patch-count {
                display: block;
                position: absolute;
                left: 0;
                right: 0;
                text-align: center;
                bottom: 72px;
            }

            .patch-file {
                position: absolute;
                display: block;
                left: 0;
                right: 0;
                text-align: center;
                bottom: 14px;
            }

            .patch-bandwidth {
                position: absolute;
                display: inline;
                left: 0;
                right: 0;
                text-align: center;
                top: 98px;
            }

            .patch-size {
                position: absolute;
                right: 22px;
                top: 146px;
            }

            .patch-transferred {
                position: absolute;
                left: 22px;
                top: 146px
            }


            mega-loader {
                top: 64px;
                position: relative;
            }


        </style>

        <paper-material class="container center-box" elevation="3">

            <span class="patch-name">[[patch.name]]</span>
            <span class="patch-version">[[patch.version]]</span>

            <template is="dom-if" if="[[downloading]]">
                <paper-progress class="download-progress transiting" min="0" max="[[patch.size]]"
                                value="[[patch.transferred]]">
                </paper-progress>

                <paper-progress class="download-progress transiting" min="0" max="[[patch.file.size]]"
                                value="[[patch.downloaded]]">

                </paper-progress>

                <span class="patch-count">[[patch.current]]/[[patch.count]]</span>
                <span class="patch-file">[[fileName]]</span>
                <span class="patch-bandwidth">{{formatBitRate(patch.bandwidth)}}</span>
                <span class="patch-size">{{formatBytes(patch.size)}}</span>
                <span class="patch-transferred">{{formatBytes(patch.transferred)}}</span>
            </template>

            <mega-loader class="loader" text="[[status]]" enabled="[[!downloading]]"></mega-loader>

            <mega-loader></mega-loader>

        </paper-material>

        <iron-ajax id="patchLoader" url="[[realm.resources]]/metadata.json" handle-as="json"
                   on-response="_onPatchMetadata"></iron-ajax>

    </template>
</dom-module>

<script>
        class PatchDownload extends Polymer.Element {

            static get is() {
                return 'patch-download';
            }

            ready() {
                super.ready();

                this.downloading = false;

                application.onUpdate((event) => {
                    this.status = "Checking version..";
                    this.downloading = false;
                    this.server = event.server;
                    this.realm = event.realm;
                    this.character = event.character;
                    this.$.patchLoader.generateRequest();
                });
            }

            _onPatchMetadata(event, request) {
                this.patch = request.response;
                this.patch.bandwidth = 0;
                this.patch.transferred = 0;
                this.patch.current = 0;
                this.patch.downloaded = 0;

                    patcher.load({
                        upToDate: () => {
                            this.status = "Loading files..";
                            this._download();
                        },
                        beginUpdate: () => {
                            this.downloading = true;
                            this._download();
                        }
                    }, this.patch, this.realm.resources);

            }

            _download() {
                patcher.update({
                            started: (name, version, size, files) => {
                                this.set("patch.size", size);
                                this.set("patch.files", files);
                                this.notifyPath("patch.size");
                            },
                            completed: (file) => {
                                if (file) {
                                    this.set("patch.downloaded", file.size);
                                    this.set("patch.transferred", this.patch.size);
                                    this.notifyPath("patch.downloaded");
                                    this.notifyPath("patch.transferred");
                                }

                                application.updateComplete({
                                    server: this.server,
                                    realm: this.realm,
                                    character: this.character,
                                    patch: this.patch,
                                    status: (text) => {
                                        this.set("status", text);
                                    }
                                });
                            },
                            progress: (bandwidth, transferred, downloaded, current) => {
                                this.set("fileName", Object.keys(this.patch.files)[current]);
                                this.set("patch.bandwidth", bandwidth);
                                this.set("patch.transferred", transferred);
                                this.set("patch.downloaded", downloaded);
                                this.set("patch.file", this.patch.files[this.fileName]);
                                this.set("patch.current", current + 1);
                                this.set("totalPercent", ((transferred * 100) / this.patch.size).toFixed(0));
                                this.set("status", "Loading files.. " + this.totalPercent + "%");
                            }
                        });
            }

            formatBytes(bits) {
                return parseFloat(bits / 1024 / 1024).toFixed(2) + " MB";
            }

            formatBitRate(bits) {
                return parseFloat(bits / 1024 / 1024).toFixed(0) + " kbps";
            }

        }
        window.customElements.define(PatchDownload.is, PatchDownload);


</script>
